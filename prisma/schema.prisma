generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

enum Plan {
  FREE
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

model User {
  id                       String              @id @default(cuid())
  email                    String              @unique
  password                 String
  name                     String?
  plan                     Plan                @default(FREE)
  stripeCustomerId         String?             @unique
  stripeSubscriptionId     String?             @unique
  subscriptionStatus       SubscriptionStatus?
  subscriptionEndDate      DateTime?
  // Email verification
  emailVerified            Boolean             @default(false)
  emailVerificationToken   String?             @unique
  emailVerificationExpires DateTime?
  // Password reset
  passwordResetToken       String?             @unique
  passwordResetExpires     DateTime?
  // Relations
  qrcodes                  QRCode[]
  apiKeys                  ApiKey[]
  customDomains            CustomDomain[]
  shortLinks               ShortLink[]
  ownedTeams               Team[]              @relation("TeamOwner")
  teamMemberships          TeamMember[]
  badgeBatches             BadgeBatch[]
  restaurants              Restaurant[]
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @default(now()) @updatedAt
}

// Modele pour les domaines personnalises (BUSINESS uniquement)
model CustomDomain {
  id                String    @id @default(cuid())
  domain            String    @unique
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  verified          Boolean   @default(false)
  verificationToken String    @unique @default(cuid())
  verifiedAt        DateTime?
  qrcodes           QRCode[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt
}

model ApiKey {
  id         String    @id @default(cuid())
  key        String    @unique
  name       String
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  expiresAt  DateTime?
}

model QRCode {
  id              String    @id @default(cuid())
  name            String
  type            String    @default("url")
  targetUrl       String
  qrContent       String?   @db.Text
  logoUrl         String?
  qrImageUrl      String?   @db.Text
  foregroundColor String    @default("#000000")
  backgroundColor String    @default("#ffffff")
  size            Int       @default(400)
  cornerStyle     String    @default("square")
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId          String?
  team            Team?     @relation("TeamQRCodes", fields: [teamId], references: [id], onDelete: SetNull)
  scans           Scan[]
  abTests         ABTest[]
  createdAt       DateTime  @default(now())
  // Champs d'expiration (PRO/BUSINESS)
  expiresAt       DateTime?
  maxScans        Int?
  isActive        Boolean   @default(true)
  // Protection par mot de passe (PRO/BUSINESS)
  passwordHash        String?
  isPasswordProtected Boolean   @default(false)
  // Domaine personnalise (BUSINESS uniquement)
  shortCode           String?   @unique
  customDomainId      String?
  customDomain        CustomDomain? @relation(fields: [customDomainId], references: [id], onDelete: SetNull)
  // Lien vers table restaurant (QR Menu)
  restaurantTable     RestaurantTable?

  @@index([teamId])
  @@index([shortCode])
}

model Scan {
  id        String   @id @default(cuid())
  qrcodeId  String
  qrcode    QRCode   @relation(fields: [qrcodeId], references: [id], onDelete: Cascade)
  userAgent String?
  ip        String?
  country   String?
  variantId String?  // ID de la variante A/B test servie
  scannedAt DateTime @default(now())
}

// Modele pour les tests A/B (PRO/BUSINESS)
model ABTest {
  id        String   @id @default(cuid())
  qrcodeId  String   @unique
  qrcode    QRCode   @relation(fields: [qrcodeId], references: [id], onDelete: Cascade)
  variants  Json     // [{id, url, weight, name}]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

// Modeles pour la gestion des equipes (BUSINESS uniquement)
enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Team {
  id          String           @id @default(cuid())
  name        String
  ownerId     String
  owner       User             @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     TeamMember[]
  qrcodes     QRCode[]         @relation("TeamQRCodes")
  invitations TeamInvitation[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now()) @updatedAt
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      TeamRole @default(MEMBER)
  createdAt DateTime @default(now())

  @@unique([teamId, userId])
}

model TeamInvitation {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  email     String
  token     String   @unique
  role      TeamRole @default(MEMBER)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// Raccourcisseur de liens
model ShortLink {
  id          String      @id @default(cuid())
  shortCode   String      @unique
  targetUrl   String
  title       String?
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  clicks      LinkClick[]
  // Options avancees (PRO/BUSINESS)
  expiresAt   DateTime?
  maxClicks   Int?
  isActive    Boolean     @default(true)
  // Protection par mot de passe (PRO/BUSINESS)
  passwordHash        String?
  isPasswordProtected Boolean   @default(false)
  // Domaine personnalise (BUSINESS uniquement)
  customDomainId      String?
  // UTM tracking
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt

  @@index([shortCode])
  @@index([userId])
}

model LinkClick {
  id          String    @id @default(cuid())
  shortLinkId String
  shortLink   ShortLink @relation(fields: [shortLinkId], references: [id], onDelete: Cascade)
  userAgent   String?
  ip          String?
  country     String?
  referer     String?
  clickedAt   DateTime  @default(now())

  @@index([shortLinkId])
}

// Modeles pour l'import de badges evenements (PRO/BUSINESS)
model BadgeBatch {
  id             String    @id @default(cuid())
  name           String
  status         String    @default("pending") // pending, processing, completed, failed
  totalCount     Int
  processedCount Int       @default(0)
  errorCount     Int       @default(0)
  errors         Json?
  badgeConfig    Json
  pdfUrl         String?
  zipUrl         String?
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  badges         Badge[]
  createdAt      DateTime  @default(now())
  completedAt    DateTime?

  @@index([userId])
}

model Badge {
  id        String     @id @default(cuid())
  firstName String
  lastName  String
  company   String
  website   String?
  linkedin  String?
  qrCodeUrl String
  imageUrl  String?
  batchId   String
  batch     BadgeBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@index([batchId])
}

// ========================================
// QR MENU - RESTAURANT MODELS
// ========================================

enum MenuTheme {
  DEFAULT
  DARK
  ELEGANT
  VIBRANT
  MINIMAL
  CUSTOM
}

enum MenuFont {
  SYSTEM        // Default system font
  INTER         // Inter - Modern sans-serif
  PLAYFAIR      // Playfair Display - Elegant serif
  POPPINS       // Poppins - Friendly sans-serif
  LORA          // Lora - Classic serif
  ROBOTO        // Roboto - Clean sans-serif
  MERRIWEATHER  // Merriweather - Readable serif
}

enum OrderingMode {
  PAYMENT_REQUIRED  // Paiement Stripe obligatoire
  CALL_WAITER       // Commander puis appeler le serveur
  PAY_LATER         // Commander et payer plus tard
}

model Restaurant {
  id              String            @id @default(cuid())
  name            String
  slug            String            @unique
  description     String?
  logoUrl         String?
  currency        String            @default("EUR")
  // Stripe Connect
  stripeAccountId String?           @unique
  stripeOnboarded Boolean           @default(false)
  // Theme du menu
  menuTheme       MenuTheme         @default(DEFAULT)
  menuFont        MenuFont          @default(SYSTEM)
  primaryColor    String            @default("#7c3aed")   // violet-600
  accentColor     String            @default("#8b5cf6")   // violet-500
  backgroundColor String            @default("#f9fafb")   // gray-50
  textColor       String            @default("#111827")   // gray-900
  showItemImages  Boolean           @default(true)
  // Mode de commande
  orderingMode    OrderingMode      @default(CALL_WAITER)
  // Proprietaire
  ownerId         String
  owner           User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  // Relations
  categories      MenuCategory[]
  tables          RestaurantTable[]
  orders          Order[]
  tags            MenuTag[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @default(now()) @updatedAt

  @@index([ownerId])
}

model MenuCategory {
  id           String     @id @default(cuid())
  name         String
  description  String?
  sortOrder    Int        @default(0)
  isActive     Boolean    @default(true)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items        MenuItem[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now()) @updatedAt

  @@index([restaurantId])
}

model MenuItem {
  id           String       @id @default(cuid())
  name         String
  description  String?
  priceInCents Int
  imageUrl     String?
  isAvailable  Boolean      @default(true)
  sortOrder    Int          @default(0)
  allergens    String[]     @default([])
  categoryId   String
  category     MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems   OrderItem[]
  tags         MenuTag[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt

  @@index([categoryId])
}

model MenuTag {
  id           String     @id @default(cuid())
  name         String
  color        String     @default("#6366f1") // Couleur du tag (hex)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items        MenuItem[]
  createdAt    DateTime   @default(now())

  @@unique([restaurantId, name])
  @@index([restaurantId])
}

model RestaurantTable {
  id           String     @id @default(cuid())
  tableNumber  String
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  // Lien vers QR code
  qrcodeId     String?    @unique
  qrcode       QRCode?    @relation(fields: [qrcodeId], references: [id], onDelete: SetNull)
  orders       Order[]
  createdAt    DateTime   @default(now())

  @@unique([restaurantId, tableNumber])
  @@index([restaurantId])
}

enum OrderStatus {
  PENDING
  PAID
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

model Order {
  id                    String          @id @default(cuid())
  orderNumber           String          @unique
  status                OrderStatus     @default(PENDING)
  tableId               String
  table                 RestaurantTable @relation(fields: [tableId], references: [id])
  restaurantId          String
  restaurant            Restaurant      @relation(fields: [restaurantId], references: [id])
  items                 OrderItem[]
  totalInCents          Int
  notes                 String?
  // Stripe
  stripePaymentIntentId String?         @unique
  stripePaymentStatus   String?
  paidAt                DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @default(now()) @updatedAt

  @@index([restaurantId, status])
  @@index([stripePaymentIntentId])
}

model OrderItem {
  id         String   @id @default(cuid())
  quantity   Int
  unitPrice  Int
  notes      String?
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
}
